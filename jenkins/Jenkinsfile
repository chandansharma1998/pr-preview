pipeline {
    agent any

    environment {
        DOCKERHUB_USER = 'sharmachandan487'
        DOCKER_IMAGE   = "${DOCKERHUB_USER}/pr-preview-app"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build & Push Image') {
          steps {
              script {
                  def prId = env.CHANGE_ID ?: "local"
                  def image = "${env.DOCKERHUB_USER}/pr-preview-app:pr-${prId}"

                  withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', 
                                                    usernameVariable: 'DOCKERHUB_USER', 
                                                    passwordVariable: 'DOCKERHUB_PASS')]) {
                      bat """
                          docker --version
                          echo Logging in to DockerHub...
                          echo %DOCKERHUB_PASS% | docker login -u %DOCKERHUB_USER% --password-stdin
                          echo Building image: ${image}
                          docker build -t ${image} app
                          echo Pushing image: ${image}
                          docker push ${image}
                      """
                  }
              }
          }
        }

        stage('Deploy with Helm') {
          steps {
              bat """
                  REM Use PR number if available, else fallback to 'local'
                  set PR_NUMBER=%CHANGE_ID%
                  if "%PR_NUMBER%"=="" set PR_NUMBER=local

                  set NAMESPACE=pr-%PR_NUMBER%

                  for /F %%i in ('minikube ip') do set MINIKUBE_IP=%%i

                  echo Creating namespace %NAMESPACE% if not exists...
                  kubectl create namespace %NAMESPACE% --dry-run=client -o yaml | kubectl apply -f -

                  echo Deploying with Helm...
                  helm upgrade --install %NAMESPACE% ./helm-chart ^
                      --namespace %NAMESPACE% ^
                      --set image.repository=%DOCKER_IMAGE% ^
                      --set image.tag=latest ^
                      --set image.pullPolicy=Always ^
                      --set prNumber=%PR_NUMBER% ^
                      --set minikubeIp=%MINIKUBE_IP%
              """
          }
        }

        stage('Verify Deployment') {
          steps {
              bat """
                  set PR_NUMBER=%CHANGE_ID%
                  if "%PR_NUMBER%"=="" set PR_NUMBER=local

                  set NAMESPACE=pr-%PR_NUMBER%

                  echo Waiting for deployment to become ready...
                  kubectl rollout status deployment/%NAMESPACE% --namespace=%NAMESPACE% --timeout=120s

                  echo Checking service...
                  kubectl get svc -n %NAMESPACE%

                  for /F %%i in ('minikube ip') do set MINIKUBE_IP=%%i
                  set URL=http://pr-%PR_NUMBER%.%MINIKUBE_IP%.nip.io

                  echo Verifying URL: %URL%
                  curl --fail %URL% || (echo "Deployment verification failed" && exit 1)
              """
          }
        }
    }

    post {
        success {
            echo "PR Preview deployed successfully! ðŸŽ‰"
            echo "Visit: http://pr-${env.CHANGE_ID}.`minikube ip`.nip.io/"
        }
        failure {
            echo "Deployment failed. Check logs."
        }
    }
}
